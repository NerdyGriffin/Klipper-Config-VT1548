# Utility and maintenance helper macros

[gcode_macro DEEP_CLEAN_NOZZLE]
description: Scrubs the nozzle repeatedly while gradually stepping down the nozzle temperature
variable_temp_step: 20 #10
variable_min_temp_step: 10 #5
gcode:
    {% set extruder_temp = params.TEMP|default(printer.configfile.settings.extruder.max_temp - 20)|int %}
    {% set loop_target = extruder_temp - min_temp_step %}
    {% set loop_start_temp = loop_target - (loop_target % temp_step) %}
    {% for clean_temp in range(loop_start_temp, 160, -temp_step) %} #199
        M109 S{clean_temp}
        AFC_BRUSH                                    # Scrub nozzle
        G28 Z
    {% endfor %}

[gcode_macro CENTER]
description: Moves the toolhead to the center
gcode:
  _CG28
  {% set x_center = 150 %}
  {% set y_center = 150 %}
  {% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
  G90
  G1 X{x_center} Y{x_center} F{travel_speed}

[gcode_macro UNSAFE_LOWER_BED]
description: Lower the bed 10mm without homing
gcode:
  G90
  SET_KINEMATIC_POSITION Z=0
  G0 Z10 F600
  M84

[delayed_gcode ENABLE_ENCODER_SENSOR]
gcode:
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1

[delayed_gcode DISABLE_ENCODER_SENSOR]
initial_duration: 1
gcode:
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
